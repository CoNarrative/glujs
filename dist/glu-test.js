// Copyright (c) 2012 CoNarrative - http://www.conarrative.com/
// License: MIT (http://www.opensource.org/licenses/mit-license.php)
// GluJS version 1.1.0
Ext.ns("glu.test.ajax"),glu.test.ajax.originalProvider=Ext.getVersion().major>3||"touch"==Ext.getProvider().provider?Ext.Ajax.request:Ext.lib.Ajax.request,glu.test.createBackend=function(config){var me={fallbackToAjax:config.fallbackToAjax||!1,defaultRoot:config.defaultRoot||"/",requests:[],routes:{},capture:function(){Ext.getVersion().major>3||"touch"==Ext.getProvider().provider?Ext.Ajax.request=this.ext4Request:Ext.lib.Ajax.request=this.ext3LibRequest},captureUrl:function(url){"/"!=url.substring(0,1)&&(url=me.defaultRoot+url);var qsIndex=url.indexOf("?");if(qsIndex>-1){var queryString=url.substring(url);url=url.substring(0,qsIndex)}return{url:url}},ext4Request:function(options){var q=me.captureUrl(options.url),url=q.url,route=me.matchRoute(url);if(void 0===route){if(me.fallbackToAjax)return glu.test.ajax.originalProvider.call(this,options),void 0;throw Error("There is no matching back-end route for "+url)}var scope=options.scope||window,requestOptions=this.setOptions(options,scope);if(this.fireEvent("beforerequest",this,options)===!1)return Ext.callback(options.callback,options.scope,[options,void 0,void 0]),null;var xhr={headers:{},setRequestHeader:function(key,header){this.headers[key]=header}},headers=this.setupHeaders(xhr,options,requestOptions.data,requestOptions.params),jsonParams=Ext.isString(options.params)?Ext.decode(options.params):options.params,request={serviceName:route.name,headers:headers,params:Ext.applyIf(route.params,jsonParams),cb:{scope:scope,success:options.success||Ext.emptyFn,failure:options.failure||Ext.emptyFn,callback:options.callback||Ext.emptyFn},url:options.url,o:options};"GET"!=options.method&&(request.jsonData=jsonParams),route.requests.push(request),me.requests.push(request),config.autoRespond&&setTimeout(function(){me.respond(request)},5)},matchRoute:function(path){for(var name in this.routes){var route=this.routes[name],captures;if(captures=route.regex.exec(path)){var keys=route.keys;route.params={};for(var i=1;captures.length>i;i++){var key=keys[i-1],val=Ext.isString(captures[i])?decodeURIComponent(captures[i]):captures[i];key&&(route.params[key.name]=val)}return route}}},ext3LibRequest:function(verb,actualUrl,cb,p,o){var q=me.captureUrl(o.url),url=q.url,route=me.matchRoute(url);if(void 0===route){if(me.fallbackToAjax)return glu.test.ajax.originalProvider.call(this,verb,actualUrl,cb,p,o),void 0;throw Error("There is no matching back-end route for "+url)}var jsonParams=Ext.isString(o.params)?Ext.decode(o.params):o.params,request={serviceName:route.name,params:Ext.applyIf(route.params,jsonParams),cb:cb,url:o.url,o:o};route.requests.push(request),me.requests.push(request),config.autoRespond&&setTimeout(function(){me.respond(request)},5)},register:function(config){"/"!=config.url.substring(0,1)&&(config.url=this.defaultRoot+config.url);var route=this.createRoute(config.verb||config.method,config.url,config.handle);route.name=config.name,route.handle=config.handle,this.routes[route.name]=route},respond:function(request,ajaxResponse){for(var sRequests=this.routes[request.serviceName].requests,i=0;sRequests.length>i;i++){var toCheck=sRequests[i];if(request==toCheck){sRequests.splice(i,1);break}}for(var i=0;this.requests.length>i;i++){var toCheck=this.requests[i];if(request==toCheck){this.requests.splice(i,1);break}}var route=this.routes[request.serviceName];ajaxResponse=ajaxResponse||route.handle(request),ajaxResponse.responseText||ajaxResponse.responseObj||(ajaxResponse={responseObj:ajaxResponse}),ajaxResponse.headers=ajaxResponse.headers||{};var keys=[];for(var key in ajaxResponse.headers)keys.push(key);for(var i=0;keys.length>i;i++){var key=keys[i];ajaxResponse.headers[key.toLowerCase()]=ajaxResponse.headers[key]}var responseText=ajaxResponse.responseText||Ext.encode(ajaxResponse.responseObj),response={tId:request.o.tId,status:200,statusText:"OK",getResponseHeader:function(header){return ajaxResponse.headers[header.toLowerCase()]},getAllResponseHeaders:function(){return ajaxResponse.headers},responseText:responseText,argument:request.cb.argument},success=response.status>=200&&300>response.status||304==response.status;success?request.cb.success.call(request.cb.scope,response):request.cb.failure.call(request.cb.scope,response),request.cb.callback&&request.cb.callback.call(request.cb.scope,request.o,success,response)},respondTo:function(serviceName,ajaxResponse){var route=this.routes[serviceName];if(!route)throw Error("Unable to find a simulated route with the name '"+serviceName+"'");if(0==route.requests.length)throw Error("Route '"+serviceName+"' does not have any pending requests to which we can respond.");this.respond(route.requests[0],ajaxResponse)},respondNext:function(ajaxResponse){this.respond(this.requests[this.requests.length-1],ajaxResponse)},getRequestsFor:function(serviceName){return this.routes[serviceName].requests},createRoute:function(method,path,options){options=options||{};var keys=[];return{path:path,method:method,regex:this.regexifyRoute(path,keys),keys:keys,requests:[]}},regexifyRoute:function(path,keys,caseSensitive){return path=path.replace(/\//g,"/"),path=path.replace(/:\w+/g,function(keyBlock){return keys.push({name:keyBlock.substring(1)}),"([^/]+.?)"}),RegExp("^"+path+"/?$",caseSensitive?"":"i")}};if(config.routes){if(glu.isObject(config.routes)){var routes=[];for(var key in config.routes){var route=config.routes[key];route.name=key,routes.push(route)}config.routes=routes}for(var i=0;config.routes.length>i;i++){var routeSpec=config.routes[i];me.register(routeSpec)}}return me},glu.test.createTable=function(fields,data){fields.fields&&(fields=fields.fields),(glu.isNumber(data)||void 0===data)&&(data=glu.test.createFakeData(fields,data||50));for(var keyIndex={},i=0;data.length>i;i++){var row=data[i];keyIndex[row.id]=row}var me={get:function(id){return keyIndex[id]},each:function(id,op){for(var ids=Ext.isArray(id)?id:[id],i=0;ids.length>i;i++){var thisId=ids[i];op(thisId)}},update:function(ids,newData){return me.each(ids,function(id){glu.apply(keyIndex[id],newData)}),{}},create:function(newData){var id=newData.id;if(void 0===id)throw Error("An id property is required");if(keyIndex[id])throw Error("Duplicate key of "+id);data.push(newData),keyIndex[id]=newData},replace:function(ids,newData){return me.each(ids,function(id){keyIndex[id]=newData,newData.id=id;for(var i=0;data.length>i;i++)if(data[i].id==id){data[i]=newData;break}}),{}},remove:function(ids){return me.each(ids,function(id){for(var i=0;data.length>i;i++)if(data[i].id==id){data.splice(i,1);break}delete keyIndex[id]}),{}},list:function(query,filterFn){function checkFilter(record,fieldFilter){var testVal=record.get(fieldFilter.field),value=fieldFilter.value;return Ext.isString(testVal)?0==testVal.indexOf(value):!1}function filterBy(record){for(var i=0;filters.length>i;i++){var include=checkFilter(record,filters[i]);if(!include)return!1}return!0}query=query||{},data=glu.deepApply(data);var params=query.params||query;params.start=query.start||0;var config={reader:new Ext.data.JsonReader({fields:fields}),data:data};if(Ext.getVersion().major>3||"touch"==Ext.getProvider().provider){var cfg=config;if(cfg.fields||cfg.reader&&cfg.reader.fields){var name="glu.test.models"+Ext.id().replace("-","_");Ext.define(name,{extend:"Ext.data.Model",fields:cfg.fields||cfg.reader.fields}),cfg.model=name}}Ext.getVersion().major>3||"touch"==Ext.getProvider().provider?(params.sorters&&(config.sorters=params.sorters),params.sort&&(config.sorters=Ext.decode(params.sort))):params.sort&&(config.sortInfo={field:params.sort,direction:params.dir});var memStore=new Ext.data.Store(config),filters=params.filters||[];params.filterText&&filters.push({field:"firstName",value:params.filterText}),filterFn?memStore.filterBy(filterFn):filters.length>0&&memStore.filterBy(filterBy);var records=memStore.getRange(),pagedRecords=[],operation=params,remaining=records.length-operation.start;operation.limit=Ext.isDefined(operation.limit)?operation.limit:remaining;for(var take=remaining>operation.limit?operation.limit:remaining,i=operation.start;operation.start+take>i;i++)pagedRecords.push(records[i].data);return{total:records.length,rows:pagedRecords}}};return me},glu.test.types={string:function(field){var name=field.name.toLowerCase(),value="";return name.indexOf("firstname")>-1?value=glu.fake.contact.firstName():name.indexOf("lastname")>-1?value=glu.fake.contact.lastName():name.indexOf("name")>-1?value=glu.fake.contact.name():name.indexOf("fax")>-1||name.indexOf("phone")>-1||name.indexOf("mobile")>-1?value=glu.fake.contact.phoneNumber():name.indexOf("dob")>-1||name.indexOf("date")>-1?value=glu.fake.date({min:"1/1/1960",max:"1/1/1972",separator:"/"}):"state"==name?glu.fake.contact.state:0==name.indexOf("postal")||0==name.indexOf("zip")?glu.fake.contact.zip(5):name.indexOf("memo")>-1||name.indexOf("description")>-1?glu.fake.words(8,12):glu.fake.title(4,5)},"int":function(field){return field.max?Math.floor(Math.random()*field.max):glu.fake.bigNumber(4)},"boolean":function(field){return glu.fake.bool()},date:function(field){return glu.fake.date({min:"1/1/1960",max:"1/1/1972",delimiter:"/"})},"float":function(field){return field.max?Math.floor(Math.random()*field.max):glu.fake.bigNumber(7)}},glu.test.types.number=glu.test.types["float"],glu.test.types.integer=glu.test.types["int"],glu.test.types.bool=glu.test.types["boolean"],glu.test.createFakeData=function(fields,number){for(var data=[],id=0,i=0;number>i;i++){var row={};data.push(row);for(var f=0;fields.length>f;f++){var field=fields[f],name=field.name,type=field.type;"id"!=field.name?row[name]=field.oneOf?glu.isNumber(field.oneOf)?Math.floor(Math.random()*field.oneOf):glu.fake.oneOf(field.oneOf):glu.test.types[type](field,row):(id+=1,row[name]=id)}}return data},Given=function(text,fn){describe("Given "+text,fn)},When=function(text,fn){describe("When "+text,fn)},Meaning=function(fn){beforeEach(fn)},Shouldve=function(text,fn){it("Should have "+text,fn)},Should=function(text,fn){it("Should "+text,fn)},ShouldHave=Shouldve,function(){var boyFirstNames="Michael,Christopher,Jason,David,James,Matthew,Joshua,John,Robert,Joseph,Daniel,Brian,Justin,William,Ryan,Eric,Nicholas,Jeremy,Andrew,Timothy,Jonathan,Adam,Kevin,Anthony,Thomas,Richard,Jeffrey,Steven,Charles,Brandon,Mark,Benjamin,Scott,Aaron,Paul,Nathan,Travis,Patrick,Chad,Stephen,Kenneth,Gregory".split(","),girlFirstNames="Jennifer,Amanda,Jessica,Melissa,Sarah,Heather,Nicole,Amy,Elizabeth,Michelle,Kimberly,Angela,Stephanie,Tiffany,Christina,Lisa,Rebecca,Crystal,Kelly,Erin,Laura,Amber,Rachel,Jamie,April,Mary,Sara,Andrea,Shannon,Megan,Emily,Julie,Danielle,Erica,Katherine,Maria,Kristin,Lauren,Kristen,Ashely,Christine,Brandy".split(","),lastNames="Smith,Johnson,Williams,Jones,Brown,Davis,Miller,Wilson,Moore,Taylor,Anderson,Thomas,Jackson,White,Harris,Martin,Thompson,Garcia,Martinez,Robinson,Clark,Rodriguez,Lewis,Lee,Walker,Hall,Allen,Young,Hernandez,King,Wright,Lopez,Hill,Scott,Green,Adams,Baker,Gonzalez,Nelson,Carter,Mitchell".split(","),codeNames="venus,apollo,mercury,jupiter,homer,bart",loremIpsum="Lorem ipsum dolor sit amet, consectetur adipisicing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum",words=loremIpsum.split(" ");glu.fake={rand:function(n){return Math.floor(n*Math.random())},range:function(min,max){return null==max&&(max=min,min=1),min+this.rand(max-min+1)},oneOf:function(set){return arguments.length>1&&(set=[].slice.call(arguments)),set=glu.isString(set)?set.split(","):set,set[this.rand(set.length)]},bigNumber:function(length){for(var out="",i=0;length>i;i++)out+=this.rand(10);return out},date:function(options){options=options||{};var min=new Date(options.min),max=new Date(options.max),d=new Date(this.range(min.getTime(),max.getTime()));return d},bool:function(){return 1>this.rand(2)},name:function(){return oneOf(codeNames)},words:function(min,max){return words.slice(0,this.range(min,max)).join(" ")},title:function(min,max){return this.words(1,4)},contact:{name:function(sex){return sex=null==sex?glu.fake.oneOf("M","F"):sex.toUpperCase(),glu.fake.oneOf("M"==sex?boyFirstNames:girlFirstNames)+" "+glu.fake.oneOf(lastNames)},firstName:function(sex){return sex=null==sex?glu.fake.oneOf("M","F"):sex.toUpperCase(),glu.fake.oneOf("M"==sex?boyFirstNames:girlFirstNames)},lastName:function(){return glu.fake.oneOf(lastNames)},phoneNumber:function(){return glu.fake.bigNumber(3)+" "+glu.fake.bigNumber(3)+"-"+glu.fake.bigNumber(4)},state:function(){return glu.fake.oneOf("TX,TN,AL,AK,MI,OH,CA")},zip:function(){return glu.fake.bigNumber(5)}}}}();