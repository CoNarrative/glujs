//
// backbone.stickit - v0.6.2
// The MIT License
// Copyright (c) 2012 The New York Times, CMS Group, Matthew DeLambo <delambo@gmail.com> 
//
(function(e){_.extend(Backbone.View.prototype,{_modelBindings:null,unstickModel:function(e){_.each(this._modelBindings,_.bind(function(t,n){if(e&&t.model!==e)return!1;t.model.off(t.event,t.fn),delete this._modelBindings[n]},this)),this._modelBindings=_.compact(this._modelBindings)},stickit:function(e,t){var n=this,i=".stickit"+this.cid,s=e||this.model,o=t||this.bindings||{},u=["autofocus","autoplay","async","checked","controls","defer","disabled","hidden","loop","multiple","open","readonly","required","scoped","selected"];this._modelBindings||(this._modelBindings=[]),this.unstickModel(s),_.each(_.keys(o),function(e){var t,a,f,c,w=o[e]||{},E=_.uniqueId();e!=":el"?t=n.$(e):(t=n.$el,e="");if(!t.length)return!1;_.isString(w)&&(w={observe:w}),f=w.observe||w.modelAttr,w.updateModel==null&&(w.updateModel=!0),w.updateView==null&&(w.updateView=!0),w.format&&!w.onGet&&(w.onGet=w.format),a=_.extend({bindKey:E},w.setOptions||{}),_.each(w.attributes||[],function(e){var r="",i=e.observe||(e.observe=f),o=function(){var o=_.indexOf(u,e.name,!0)>-1?"prop":"attr",a=v(s,i,e,n);e.name=="class"?(t.removeClass(r).addClass(a),r=a):t[o](e.name,a)};e.format&&!e.onGet&&(e.onGet=e.format),_.each(_.flatten([i]),function(e){p(s,n,"change:"+e,o)}),o()}),w.visible!=null&&(c=function(){y(t,v(s,f,w,n),w,n)},p(s,n,"change:"+f,c),c()),f&&((r(t)||l(t))&&_.each(w.eventsOverride||m(t),function(r){var o=r+i,u=function(){var e=g(t,l(t));h(n,w.updateModel,e,w)&&d(s,f,e,a,w.onSet,n,w)};e===""?n.$el.on(o,u):n.$el.on(o,e,u)}),_.each(_.flatten([f]),function(e){p(s,n,"change:"+e,function(e,r,i){(i==null||i.bindKey!=E)&&b(n,t,w,v(e,f,w,n),e)})}),b(n,t,w,v(s,f,w,n),s,!0))}),this.remove=_.wrap(this.remove,function(e){n.unstickModel(),n.$el.off(i),e&&e.call(n)})}});var t=function(e,t){var n=(t||"").split("."),r=_.reduce(n,function(e,t){return e[t]},e);return r==null?e:r},n=function(e,t){if(t)return(_.isString(t)?e[t]:t).apply(e,_.toArray(arguments).slice(2))},r=function(e){return _.indexOf(["CHECKBOX","INPUT","SELECT","TEXTAREA"],e[0].nodeName,!0)>-1},i=function(e){return e.is("input[type=checkbox]")},s=function(e){return e.is('input[type="radio"]')},o=function(e){return e.is("input[type=number]")},u=function(e){return e.is("select")},a=function(e){return e.is("textarea")},f=function(e){return e.is("input")},l=function(e){return e.is('[contenteditable="true"]')},c=function(e){return e.find("option").not(function(){return!this.selected})},h=function(e,t){return _.isBoolean(t)?t:_.isFunction(t)||_.isString(t)?n.apply(this,_.toArray(arguments)):!1},p=function(e,t,n,r){e.on(n,r,t),t._modelBindings.push({model:e,event:n,fn:r})},d=function(e,t,r,i,s,o,u){s&&(r=n(o,s,r,u)),e.set(t,r,i)},v=function(e,t,r,i){var s,o=function(t){var n=r.escape?e.escape(t):e.get(t);return _.isUndefined(n)?"":n};return s=_.isArray(t)?_.map(t,o):o(t),r.onGet?n(i,r.onGet,s,r):s},m=function(e){return f(e)||a(e)||l(e)?["keyup","change","paste","cut"]:["change"]},g=function(t,n){var a;if(r(t))if(o(t))a=Number(t.val());else if(s(t))a=t.filter(":checked").val();else if(i(t))if(t.length>1)a=_.reduce(t,function(t,n){return e(n).prop("checked")&&t.push(e(n).val()),t},[]);else{a=t.prop("checked");var f=t.val();f!="on"&&f!=null&&(a?a=t.val():a=null)}else u(t)?t.prop("multiple")?a=e(c(t).map(function(){return e(this).data("stickit_bind_val")})).get():a=c(t).data("stickit_bind_val"):a=t.val();else n?a=t.html():a=t.text();return a},y=function(e,t,r,i){var s=r.visible,o=r.visibleFn,u=!!t;if(_.isFunction(s)||_.isString(s))u=n(i,s,t,r);o?n(i,o,e,u,r):u?e.show():e.hide()},b=function(r,o,c,p,d,v){var m=c.observe||c.modelAttr,y=c.afterUpdate,b=c.selectOptions,E=c.updateMethod||"text",S=g(o,c.updateMethod=="html"||l(o));if(!h(r,c.updateView,p,c))return;if(s(o))o.filter('[value="'+p+'"]').prop("checked",!0);else if(i(o))o.length>1?(p||(p=[]),_.each(o,function(t){_.indexOf(p,e(t).val())>-1?e(t).prop("checked",!0):e(t).prop("checked",!1)})):_.isBoolean(p)?o.prop("checked",p):o.prop("checked",p==o.val());else if(f(o)||a(o))o.val(p);else if(l(o))o.html(p);else if(u(o)){var x,T=b.collection,N=o.prop("multiple");o.html(""),x=_.isFunction(T)?n(r,T):t(window,T),p==null&&o.append("<option/>").find("option").prop("selected",!0).data("stickit_bind_val",p),_.isArray(x)?w(x,o,b,p,N):_.each(x.opt_labels,function(t){var n=e("<optgroup/>").attr("label",t);w(x[t],n,b,p,N),o.append(n)})}else o[E](p);v||n(r,y,o,p,S,c)},w=function(n,r,i,s,o){_.each(n,function(n){var u=e("<option/>"),a=n;if(n!=null)u.text(t(n,i.labelPath||"label")),a=t(n,i.valuePath||"value");else if(r.find("option").length&&r.find("option").eq(0).data("stickit_bind_val")==null)return!1;u.data("stickit_bind_val",a),!o&&a!=null&&s!=null&&a==s||_.isObject(s)&&_.isEqual(a,s)?u.prop("selected",!0):o&&_.isArray(s)&&_.each(s,function(e){_.isObject(e)&&(e=t(e,i.valuePath)),(e==a||_.isObject(e)&&_.isEqual(a,e))&&u.prop("selected",!0)}),r.append(u)})}})(window.jQuery||window.Zepto);